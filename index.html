<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âõ≥ÂΩ¢Èù¢Á©çË®àÁÆó„Ç¢„Éó„É™</title>
    <style>
        /* CSS„ÅØÂ§âÊõ¥„Å™„Åó */
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #333;
        }

        html, body {
            height: 100%;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .calculator-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shape-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            background: #e9ecef;
            color: #495057;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .tab-button.active {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }

        .tab-button:hover:not(.active) {
            background: #dee2e6;
            transform: translateY(-1px);
        }

        .calculator-form {
            display: none;
        }

        .calculator-form.active {
            display: block;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .calculate-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40,167,69,0.3);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            font-weight: 600;
            color: #155724;
            display: none;
        }

        .division-section {
            background: #fff3cd;
            border-radius: 15px;
            padding: 25px;
        }

        .division-list {
            margin-top: 20px;
        }

        .division-item {
            background: white;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .division-info {
            flex: 1;
        }

        .division-name {
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 5px;
        }

        .division-area {
            color: #636e72;
            font-size: 0.9rem;
        }

        .remove-btn {
            background: #e17055;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #d63031;
            transform: scale(1.05);
        }

        .total-area {
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 700;
            margin-top: 20px;
        }

        .add-division-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .add-division-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(253,121,168,0.3);
        }

        .check-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .check-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108,92,231,0.3);
        }

        .shape-display {
            text-align: center;
            margin: 15px 0;
        }

        .answer-section {
            margin-top: 20px;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
            border-left: 4px solid #6c5ce7;
        }

        .result.correct {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .result.incorrect {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .formula {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9rem;
            color: #1565c0;
        }

        .drawing-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
            background: #e9ecef;
            padding: 10px;
            border-radius: 8px;
        }
        .drawing-tools label {
            font-weight: 500;
            color: #495057;
            user-select: none; /* „É©„Éô„É´ÈÅ∏Êäû„ÇíÈò≤„Åê */
        }
        .drawing-tools input[type="radio"], .drawing-tools input[type="checkbox"] {
            margin-right: 5px;
        }
        .drawing-tools button {
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            background: #e17055;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }
        .drawing-tools button:hover {
            background: #d63031;
        }


        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .shape-tabs {
                justify-content: center;
            }

            .tab-button {
                font-size: 0.8rem;
                padding: 8px 12px;
            }

            .drawing-tools {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìê Âõ≥ÂΩ¢Èù¢Á©çË®àÁÆó„Ç¢„Éó„É™</h1>
            <p>Âü∫Êú¨Âõ≥ÂΩ¢„ÅÆÈù¢Á©çË®àÁÆó„Å®Ë§áÈõë„Å™Âõ≥ÂΩ¢„ÅÆÂàÜÂâ≤Ë®àÁÆó„Åå„Åß„Åç„Åæ„Åô</p>
        </header>

        <main class="main-content">
            <section class="calculator-section">
                <h2 class="section-title">
                    üî¢ Èù¢Á©çË®àÁÆó
                </h2>

                <div class="shape-tabs">
                    <button class="tab-button active" data-shape="rectangle">Èï∑ÊñπÂΩ¢</button>
                    <button class="tab-button" data-shape="square">Ê≠£ÊñπÂΩ¢</button>
                    <button class="tab-button" data-shape="triangle">‰∏âËßíÂΩ¢</button>
                    <button class="tab-button" data-shape="parallelogram">Âπ≥Ë°åÂõõËæ∫ÂΩ¢</button>
                    <button class="tab-button" data-shape="u-shape">„Ç≥„ÅÆÂ≠óÂûã</button>
                    <button class="tab-button" data-shape="hollow-square">Á©¥„ÅÇ„ÅçÊ≠£ÊñπÂΩ¢</button>
                    <button class="tab-button" data-shape="l-shape">LÂ≠óÂûã</button>
                </div>

                <form class="calculator-form active" id="rectangle-form">
                    <div class="input-group">
                        <label for="rect-width">Ê®™„ÅÆÈï∑„Åï (cm)</label>
                        <input type="number" id="rect-width" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="rect-height">Á∏¶„ÅÆÈï∑„Åï (cm)</label>
                        <input type="number" id="rect-height" step="0.1" min="0" required>
                    </div>
                    <button type="button" class="calculate-btn" onclick="drawRectangle()">Âõ≥ÂΩ¢„ÇíË°®Á§∫</button>

                    <div class="answer-section" id="rectangle-answer" style="display: none;">
                        <div class="input-group">
                            <label for="rect-answer">„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà (cm¬≤)</label>
                            <input type="number" id="rect-answer" step="0.1" min="0" required>
                        </div>
                        <button type="button" class="check-btn" onclick="checkRectangleAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                        <div class="result" id="rectangle-result"></div>
                    </div>
                </form>

                <form class="calculator-form" id="square-form">
                    <div class="input-group">
                        <label for="square-side">‰∏ÄËæ∫„ÅÆÈï∑„Åï (cm)</label>
                        <input type="number" id="square-side" step="0.1" min="0" required>
                    </div>
                    <button type="button" class="calculate-btn" onclick="drawSquare()">Âõ≥ÂΩ¢„ÇíË°®Á§∫</button>

                    <div class="answer-section" id="square-answer" style="display: none;">
                        <div class="input-group">
                            <label for="square-answer-input">„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà (cm¬≤)</label>
                            <input type="number" id="square-answer-input" step="0.1" min="0" required>
                        </div>
                        <button type="button" class="check-btn" onclick="checkSquareAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                        <div class="result" id="square-result"></div>
                    </div>
                </form>

                <form class="calculator-form" id="triangle-form">
                    <div class="input-group">
                        <label for="triangle-base">Â∫ïËæ∫„ÅÆÈï∑„Åï (cm)</label>
                        <input type="number" id="triangle-base" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="triangle-height">È´ò„Åï (cm)</label>
                        <input type="number" id="triangle-height" step="0.1" min="0" required>
                    </div>
                    <button type="button" class="calculate-btn" onclick="drawTriangle()">Âõ≥ÂΩ¢„ÇíË°®Á§∫</button>

                    <div class="answer-section" id="triangle-answer" style="display: none;">
                        <div class="input-group">
                            <label for="triangle-answer-input">„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà (cm¬≤)</label>
                            <input type="number" id="triangle-answer-input" step="0.1" min="0" required>
                        </div>
                        <button type="button" class="check-btn" onclick="checkTriangleAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                        <div class="result" id="triangle-result"></div>
                    </div>
                </form>

                <form class="calculator-form" id="parallelogram-form">
                    <div class="input-group">
                        <label for="para-base">Â∫ïËæ∫„ÅÆÈï∑„Åï (cm)</label>
                        <input type="number" id="para-base" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="para-height">È´ò„Åï (cm)</label>
                        <input type="number" id="para-height" step="0.1" min="0" required>
                    </div>
                    <button type="button" class="calculate-btn" onclick="drawParallelogram()">Âõ≥ÂΩ¢„ÇíË°®Á§∫</button>

                    <div class="answer-section" id="parallelogram-answer" style="display: none;">
                        <div class="input-group">
                            <label for="parallelogram-answer-input">„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà (cm¬≤)</label>
                            <input type="number" id="parallelogram-answer-input" step="0.1" min="0" required>
                        </div>
                        <button type="button" class="check-btn" onclick="checkParallelogramAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                        <div class="result" id="parallelogram-result"></div>
                    </div>
                </form>

                <form class="calculator-form" id="u-shape-form">
                    <div class="input-group">
                        <label for="u-outer-width">Â§ñÂÅ¥„ÅÆÊ®™ÂπÖ (cm)</label>
                        <input type="number" id="u-outer-width" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="u-outer-height">Â§ñÂÅ¥„ÅÆÁ∏¶ÂπÖ (cm)</label>
                        <input type="number" id="u-outer-height" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="u-indent-width">„Å∏„Åì„Åø„ÅÆÂπÖ (cm)</label>
                        <input type="number" id="u-indent-width" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="u-indent-depth">„Å∏„Åì„Åø„ÅÆÊ∑±„Åï (cm)</label>
                        <input type="number" id="u-indent-depth" step="0.1" min="0" required>
                    </div>
                    <button type="button" class="calculate-btn" onclick="drawUShape()">Âõ≥ÂΩ¢„ÇíË°®Á§∫</button>

                    <div class="answer-section" id="u-shape-answer" style="display: none;">
                        <div class="input-group">
                            <label for="u-shape-answer-input">„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà (cm¬≤)</label>
                            <input type="number" id="u-shape-answer-input" step="0.1" min="0" required>
                        </div>
                        <button type="button" class="check-btn" onclick="checkUShapeAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                        <div class="result" id="u-shape-result"></div>
                    </div>
                </form>

                <form class="calculator-form" id="hollow-square-form">
                    <div class="input-group">
                        <label for="hollow-outer-size">Â§ñÂÅ¥„ÅÆ‰∏ÄËæ∫ (cm)</label>
                        <input type="number" id="hollow-outer-size" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="hollow-inner-size">ÂÜÖÂÅ¥„ÅÆ‰∏ÄËæ∫ (cm)</label>
                        <input type="number" id="hollow-inner-size" step="0.1" min="0" required>
                    </div>
                    <button type="button" class="calculate-btn" onclick="drawHollowSquare()">Âõ≥ÂΩ¢„ÇíË°®Á§∫</button>

                    <div class="answer-section" id="hollow-square-answer" style="display: none;">
                        <div class="input-group">
                            <label for="hollow-square-answer-input">„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà (cm¬≤)</label>
                            <input type="number" id="hollow-square-answer-input" step="0.1" min="0" required>
                        </div>
                        <button type="button" class="check-btn" onclick="checkHollowSquareAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                        <div class="result" id="hollow-square-result"></div>
                    </div>
                </form>

                <form class="calculator-form" id="l-shape-form">
                    <div class="input-group">
                        <label for="l-width1">Ê®™ÈÉ®ÂàÜ„ÅÆÂπÖ (cm)</label>
                        <input type="number" id="l-width1" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="l-height1">Ê®™ÈÉ®ÂàÜ„ÅÆÈ´ò„Åï (cm)</label>
                        <input type="number" id="l-height1" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="l-width2">Á∏¶ÈÉ®ÂàÜ„ÅÆÂπÖ (cm)</label>
                        <input type="number" id="l-width2" step="0.1" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="l-height2">Á∏¶ÈÉ®ÂàÜ„ÅÆÈ´ò„Åï (cm)</label>
                        <input type="number" id="l-height2" step="0.1" min="0" required>
                    </div>
                    <button type="button" class="calculate-btn" onclick="drawLShape()">Âõ≥ÂΩ¢„ÇíË°®Á§∫</button>

                    <div class="answer-section" id="l-shape-answer" style="display: none;">
                        <div class="input-group">
                            <label for="l-shape-answer-input">„ÅÇ„Å™„Åü„ÅÆÁ≠î„Åà (cm¬≤)</label>
                            <input type="number" id="l-shape-answer-input" step="0.1" min="0" required>
                        </div>
                        <button type="button" class="check-btn" onclick="checkLShapeAnswer()">Á≠î„Åà„ÇíÁ¢∫Ë™ç</button>
                        <div class="result" id="l-shape-result"></div>
                    </div>
                </form>
            </section>

            <section class="calculator-section">
                <h2 class="section-title">
                    üìä Âõ≥ÂΩ¢Ë°®Á§∫„Ç®„É™„Ç¢
                </h2>
                <p style="margin-bottom: 20px; color: #495057;">ÈÅ∏Êäû„Åó„ÅüÂõ≥ÂΩ¢„Åå„Åì„Åì„Å´Â§ß„Åç„ÅèË°®Á§∫„Åï„Çå„Åæ„Åô</p>

                <div class="drawing-tools">
                    <div>
                        <input type="checkbox" id="grid-toggle" checked>
                        <label for="grid-toggle">ÊñπÁúº</label>
                    </div>
                    <div>
                        <label>„É¢„Éº„Éâ:</label>
                        <input type="radio" name="op-mode" id="mode-move" value="move" checked>
                        <label for="mode-move">ÁßªÂãï</label>
                        <input type="radio" name="op-mode" id="mode-draw" value="draw">
                        <label for="mode-draw">ÊèèÁîª</label>
                    </div>
                    <button type="button" id="clear-lines-btn">Á∑ö„ÇíÂÖ®ÂâäÈô§</button>
                </div>
                <div id="main-shape-display" style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 15px; min-height: 400px; display: flex; align-items: center; justify-content: center; touch-action: none;">
                    <div style="color: #6c757d; font-size: 1.1rem;">
                        üìê Â∑¶ÂÅ¥„ÅßÂõ≥ÂΩ¢„ÇíÈÅ∏Êäû„Åó„Å¶„ÄåÂõ≥ÂΩ¢„ÇíË°®Á§∫„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let divisions = [];
        let currentResult = null;
        let currentShapeName = '';

        let currentGridScale = 20;
        let isDrawingLine = false;
        let startLinePoint = { x: 0, y: 0 };
        let previewLine = null;
        let svgElement = null;
        let svgRect = null;
        let currentMode = 'move'; // Êìç‰Ωú„É¢„Éº„Éâ (move | draw)
        // ‚ñº‚ñº‚ñº ‰øÆÊ≠£: „Éâ„É©„ÉÉ„Ç∞ÈñãÂßãÊôÇ„ÅÆÂõ≥ÂΩ¢„Ç∞„É´„Éº„Éó„ÅÆÁßªÂãïÈáè ‚ñº‚ñº‚ñº
        let dragInitialTransform = { x: 0, y: 0 };


        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.calculator-form').forEach(form => form.classList.remove('active'));
                const targetForm = document.getElementById(button.dataset.shape + '-form');
                targetForm.classList.add('active');
                clearResults();
            });
        });

        // ÊñπÁúº„ÇíÊèèÁîª„Åô„ÇãÈñ¢Êï∞ (Ëâ≤Â§âÊõ¥)
        function drawGrid(svg, width, height, scale) {
            const gridSize = Math.max(scale, 15);

            let gridPattern = '<g id="grid-layer">';

            // Á¥∞„ÅÑ„Ç∞„É™„ÉÉ„ÉâÁ∑ö (ÊøÉ„ÅèÂ§âÊõ¥)
            gridPattern += `<defs><pattern id="grid" width="${gridSize}" height="${gridSize}" patternUnits="userSpaceOnUse"><path d="M ${gridSize} 0 L 0 0 0 ${gridSize}" fill="none" stroke="#333" stroke-width="0.5"/></pattern></defs>`;
            gridPattern += `<rect width="${width}" height="${height}" fill="url(#grid)"/>`;

            // 5cmÈñìÈöî„ÅßÂ§™„ÅÑÁ∑ö„ÇíËøΩÂä† (Èªí„Å´Â§âÊõ¥)
            const majorGridSize = gridSize * 5;
            for (let x = 0; x <= width; x += majorGridSize) {
                gridPattern += `<line x1="${x}" y1="0" x2="${x}" y2="${height}" stroke="#000" stroke-width="1"/>`;
            }
            for (let y = 0; y <= height; y += majorGridSize) {
                gridPattern += `<line x1="0" y1="${y}" x2="${width}" y2="${y}" stroke="#000" stroke-width="1"/>`;
            }

            gridPattern += '</g>';
            return gridPattern;
        }

        // ‚ñº‚ñº‚ñº SVG„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö (‰øÆÊ≠£„Å™„Åó) ‚ñº‚ñº‚ñº
        function setupSVGEventListeners(scale) {
            currentGridScale = scale;
            svgElement = document.getElementById('main-shape-display').querySelector('svg');
            if (!svgElement) return;

            svgRect = svgElement.getBoundingClientRect();
            dragInitialTransform = {x: 0, y: 0}; // ÁßªÂãïÈáè„É™„Çª„ÉÉ„Éà

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅØSVGÂÖ®‰Ωì„Å´Ë®≠ÂÆö (ÊèèÁîªÈñãÂßãÂà§ÂÆö„ÅÆ„Åü„ÇÅ)
            svgElement.addEventListener('mousedown', startInteraction);
            svgElement.addEventListener('mousemove', moveInteraction);
            svgElement.addEventListener('mouseup', endInteraction);
            svgElement.addEventListener('mouseleave', endInteraction);
            svgElement.addEventListener('touchstart', startInteraction, { passive: false });
            svgElement.addEventListener('touchmove', moveInteraction, { passive: false });
            svgElement.addEventListener('touchend', endInteraction);

            toggleGrid();
            updateCursors(); // „Ç´„Éº„ÇΩ„É´„ÇíÂàùÊúüÂåñ
        }

        // ‚ñº‚ñº‚ñº ÂÖ±ÈÄö„ÅÆÈñãÂßãÂá¶ÁêÜ (mousedown/touchstart) (‰øÆÊ≠£„Å™„Åó) ‚ñº‚ñº‚ñº
        function startInteraction(e) {
            if (currentMode === 'move' && e.target.closest('#draggable-shape')) {
                onDragStart(e);
            } else if (currentMode === 'draw') {
                startDrawLine(e);
            }
        }
        // ‚ñº‚ñº‚ñº ÂÖ±ÈÄö„ÅÆÁßªÂãïÂá¶ÁêÜ (mousemove/touchmove) (‰øÆÊ≠£„Å™„Åó) ‚ñº‚ñº‚ñº
        function moveInteraction(e) {
             if (isDragging) {
                 onDragMove(e);
             } else if (isDrawingLine) {
                 drawLineMove(e);
             }
        }
        // ‚ñº‚ñº‚ñº ÂÖ±ÈÄö„ÅÆÁµÇ‰∫ÜÂá¶ÁêÜ (mouseup/touchend/mouseleave) (‰øÆÊ≠£„Å™„Åó) ‚ñº‚ñº‚ñº
        function endInteraction(e) {
             if (isDragging) {
                 onDragEnd(e);
             } else if (isDrawingLine) {
                 endDrawLine(e);
             }
        }


        // Èï∑ÊñπÂΩ¢„ÇíÊèèÁîª (Ëâ≤Â§âÊõ¥)
        function drawRectangle() {
            const width = parseFloat(document.getElementById('rect-width').value);
            const height = parseFloat(document.getElementById('rect-height').value);
            if (!width || !height) return;

            const maxWidth = 350;
            const maxHeight = 250;
            const scaleX = maxWidth / width;
            const scaleY = maxHeight / height;
            const scale = Math.max(Math.min(scaleX, scaleY), 20);
            const displayWidth = width * scale;
            const displayHeight = height * scale;
            const rectX = Math.round((500 - displayWidth) / 2 / scale) * scale;
            const rectY = Math.round((350 - displayHeight) / 2 / scale) * scale;

            const mainDisplay = document.getElementById('main-shape-display');
            mainDisplay.innerHTML = `
                <svg width="500" height="350" style="border: 2px solid #ddd; border-radius: 8px; background: white; user-select: none;">
                    ${drawGrid(null, 500, 350, scale)}
                    <g id="draggable-shape">
                        <rect x="${rectX}" y="${rectY}" width="${displayWidth}" height="${displayHeight}"
                                fill="#FFEB3B" stroke="#FBC02D" stroke-width="3" opacity="0.8"></rect>
                        <rect x="${rectX + displayWidth / 2 - 25}" y="${rectY - 35}" width="50" height="20" fill="white" stroke="#333" stroke-width="1" rx="3"></rect>
                        <text x="${rectX + displayWidth / 2}" y="${rectY - 20}" text-anchor="middle" font-size="18" font-weight="700" fill="#333">${width}cm</text>
                        <rect x="${rectX - 50}" y="${rectY + displayHeight / 2 - 10}" width="40" height="20" fill="white" stroke="#333" stroke-width="1" rx="3"></rect>
                        <text x="${rectX - 30}" y="${rectY + displayHeight / 2 + 5}" text-anchor="middle" font-size="18" font-weight="700" fill="#333">${height}cm</text>
                    </g>
                </svg>
            `;

            setupSVGEventListeners(scale);
            makeDraggable('draggable-shape', scale);
            document.getElementById('rectangle-answer').style.display = 'block';
            currentResult = width * height;
            currentShapeName = `Èï∑ÊñπÂΩ¢ (${width}√ó${height})`;
        }

        // Ê≠£ÊñπÂΩ¢„ÇíÊèèÁîª (Ëâ≤Â§âÊõ¥)
        function drawSquare() {
            const side = parseFloat(document.getElementById('square-side').value);
            if (!side) return;

            const maxSize = 280;
            const scale = Math.max(maxSize / side, 20);
            const displaySize = side * scale;
            const squareX = Math.round((500 - displaySize) / 2 / scale) * scale;
            const squareY = Math.round((350 - displaySize) / 2 / scale) * scale;

            const mainDisplay = document.getElementById('main-shape-display');
            mainDisplay.innerHTML = `
                <svg width="500" height="350" style="border: 2px solid #ddd; border-radius: 8px; background: white; user-select: none;">
                    ${drawGrid(null, 500, 350, scale)}
                    <g id="draggable-shape">
                        <rect x="${squareX}" y="${squareY}" width="${displaySize}" height="${displaySize}"
                                fill="#FFEB3B" stroke="#FBC02D" stroke-width="3" opacity="0.8"></rect>
                        <rect x="${squareX + displaySize / 2 - 25}" y="${squareY - 35}" width="50" height="20" fill="white" stroke="#333" stroke-width="1" rx="3"></rect>
                        <text x="${squareX + displaySize / 2}" y="${squareY - 20}" text-anchor="middle" font-size="18" font-weight="700" fill="#333">${side}cm</text>
                        <rect x="${squareX - 50}" y="${squareY + displaySize / 2 - 10}" width="40" height="20" fill="white" stroke="#333" stroke-width="1" rx="3"></rect>
                        <text x="${squareX - 30}" y="${squareY + displaySize / 2 + 5}" text-anchor="middle" font-size="18" font-weight="700" fill="#333">${side}cm</text>
                    </g>
                </svg>
            `;

            setupSVGEventListeners(scale);
            makeDraggable('draggable-shape', scale);
            document.getElementById('square-answer').style.display = 'block';
            currentResult = side * side;
            currentShapeName = `Ê≠£ÊñπÂΩ¢ (‰∏ÄËæ∫${side})`;
        }

        // ‰∏âËßíÂΩ¢„ÇíÊèèÁîª (Ëâ≤Â§âÊõ¥)
        function drawTriangle() {
            const base = parseFloat(document.getElementById('triangle-base').value);
            const height = parseFloat(document.getElementById('triangle-height').value);
            if (!base || !height) return;

            const maxWidth = 350;
            const maxHeight = 250;
            const scaleX = maxWidth / base;
            const scaleY = maxHeight / height;
            const scale = Math.max(Math.min(scaleX, scaleY), 20);
            const displayBase = base * scale;
            const displayHeight = height * scale;
            const centerX = Math.round(250 / scale) * scale;
            const bottomY = Math.round(300 / scale) * scale;
            const topY = bottomY - displayHeight;
            const points = `${centerX - displayBase/2},${bottomY} ${centerX + displayBase/2},${bottomY} ${centerX},${topY}`;

            const mainDisplay = document.getElementById('main-shape-display');
            mainDisplay.innerHTML = `
                <svg width="500" height="350" style="border: 2px solid #ddd; border-radius: 8px; background: white; user-select: none;">
                    ${drawGrid(null, 500, 350, scale)}
                    <g id="draggable-shape">
                        <polygon points="${points}" fill="#FFEB3B" stroke="#FBC02D" stroke-width="3" opacity="0.8"></polygon>
                        <line x1="${centerX}" y1="${topY}" x2="${centerX}" y2="${bottomY}" stroke="#333" stroke-width="2" stroke-dasharray="5,5"></line>
                        <rect x="${centerX - 25}" y="${bottomY + 10}" width="50" height="20" fill="white" stroke="#333" stroke-width="1" rx="3"></rect>
                        <text x="${centerX}" y="${bottomY + 25}" text-anchor="middle" font-size="18" font-weight="700" fill="#333">${base}cm</text>
                        <rect x="${centerX - 60}" y="${topY + displayHeight / 2 - 10}" width="50" height="20" fill="white" stroke="#333" stroke-width="1" rx="3"></rect>
                        <text x="${centerX - 35}" y="${topY + displayHeight / 2 + 5}" text-anchor="middle" font-size="18" font-weight="700" fill="#333">${height}cm</text>
                    </g>
                </svg>
            `;

            setupSVGEventListeners(scale);
            makeDraggable('draggable-shape', scale);
            document.getElementById('triangle-answer').style.display = 'block';
            currentResult = (base * height) / 2;
            currentShapeName = `‰∏âËßíÂΩ¢ (Â∫ïËæ∫${base}√óÈ´ò„Åï${height})`;
        }

        // Âπ≥Ë°åÂõõËæ∫ÂΩ¢„ÇíÊèèÁîª (‰øÆÊ≠£)
        function drawParallelogram() {
            const base = parseFloat(document.getElementById('para-base').value);
            const height = parseFloat(document.getElementById('para-height').value);
            if (!base || !height) return;

            const maxWidth = 400; // SVGÂÜÖ„ÅÆÊèèÁîªÂèØËÉΩÂπÖ
            const maxHeight = 280; // SVGÂÜÖ„ÅÆÊèèÁîªÂèØËÉΩÈ´ò„Åï

            const totalWidth = base * 1.3;
            const scaleX = maxWidth / totalWidth;
            const scaleY = maxHeight / height;
            const scale = Math.min(scaleX, scaleY);

            const displayBase = base * scale;
            const displayHeight = height * scale;
            const offset = displayBase * 0.3; // ÂÇæ„Åç

            const totalDisplayWidth = displayBase + offset;
            const leftX = Math.round((500 - totalDisplayWidth) / 2 / scale) * scale;
            const topY = Math.round((350 - displayHeight) / 2 / scale) * scale;
            const bottomY = topY + displayHeight;

            const points = `${leftX},${bottomY} ${leftX + displayBase},${bottomY} ${leftX + displayBase + offset},${topY} ${leftX + offset},${topY}`;

            const mainDisplay = document.getElementById('main-shape-display');
            mainDisplay.innerHTML = `
                <svg width="500" height="350" style="border: 2px solid #ddd; border-radius: 8px; background: white; user-select: none;">
                    ${drawGrid(null, 500, 350, scale)}
                    <g id="draggable-shape">
                        <polygon points="${points}" fill="#FFEB3B" stroke="#FBC02D" stroke-width="3" opacity="0.8"></polygon>
                        <line x1="${leftX + offset}" y1="${topY}" x2="${leftX + offset}" y2="${bottomY}" stroke="#333" stroke-width="2" stroke-dasharray="5,5"></line>
                        <text x="${leftX + displayBase / 2}" y="${bottomY + 20}" text-anchor="middle" font-size="16" font-weight="600" fill="#333">${base}cm</text>
                        <text x="${leftX + offset - 20}" y="${topY + displayHeight / 2 + 5}" text-anchor="middle" font-size="16" font-weight="600" fill="#333"
                                transform="rotate(-90, ${leftX + offset - 20}, ${topY + displayHeight / 2 + 5})">${height}cm</text>
                    </g>
                </svg>
            `;

            setupSVGEventListeners(scale);
            makeDraggable('draggable-shape', scale);
            document.getElementById('parallelogram-answer').style.display = 'block';
            currentResult = base * height;
            currentShapeName = `Âπ≥Ë°åÂõõËæ∫ÂΩ¢ (Â∫ïËæ∫${base}√óÈ´ò„Åï${height})`;
        }

        // „Ç≥„ÅÆÂ≠óÂûã„ÇíÊèèÁîª (Ëâ≤Â§âÊõ¥)
        function drawUShape() {
            const outerWidth = parseFloat(document.getElementById('u-outer-width').value);
            const outerHeight = parseFloat(document.getElementById('u-outer-height').value);
            const indentWidth = parseFloat(document.getElementById('u-indent-width').value);
            const indentDepth = parseFloat(document.getElementById('u-indent-depth').value);
            if (!outerWidth || !outerHeight || !indentWidth || !indentDepth) return;
            if (indentWidth >= outerWidth || indentDepth >= outerHeight) {
                alert("„Å∏„Åì„Åø„ÅÆÂπÖ„ÇÑÊ∑±„Åï„ÅØ„ÄÅÂ§ñÂÅ¥„ÅÆÂπÖ„ÇÑÈ´ò„Åï„Çà„ÇäÂ∞è„Åï„Åè„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                return;
            }

            const maxWidth = 400;
            const maxHeight = 280;
            const scaleX = maxWidth / outerWidth;
            const scaleY = maxHeight / outerHeight;
            const scale = Math.min(scaleX, scaleY);
            const displayOuterWidth = outerWidth * scale;
            const displayOuterHeight = outerHeight * scale;
            const innerHeight = outerHeight - indentDepth;
            const displayInnerWidth = indentWidth * scale;
            const displayInnerHeight = innerHeight * scale;
            const gridStartX = Math.round((500 - displayOuterWidth) / 2 / scale) * scale;
            const gridStartY = Math.round((350 - displayOuterHeight) / 2 / scale) * scale;
            const startX = gridStartX;
            const startY = gridStartY;
            const wallThickness = (displayOuterWidth - displayInnerWidth) / 2;
            const path = `M ${startX} ${startY} L ${startX + displayOuterWidth} ${startY} L ${startX + displayOuterWidth} ${startY + displayOuterHeight} L ${startX + displayOuterWidth - wallThickness} ${startY + displayOuterHeight} L ${startX + displayOuterWidth - wallThickness} ${startY + displayInnerHeight} L ${startX + wallThickness} ${startY + displayInnerHeight} L ${startX + wallThickness} ${startY + displayOuterHeight} L ${startX} ${startY + displayOuterHeight} Z`;

            const mainDisplay = document.getElementById('main-shape-display');
            mainDisplay.innerHTML = `
                <svg width="500" height="350" style="border: 2px solid #ddd; border-radius: 8px; background: white; user-select: none;">
                    ${drawGrid(null, 500, 350, scale)}
                    <g id="draggable-shape">
                        <path d="${path}" fill="#FFEB3B" stroke="#FBC02D" stroke-width="3" opacity="0.8"></path>
                        <text x="${startX + displayOuterWidth / 2}" y="${startY - 10}" text-anchor="middle" font-size="16" font-weight="600" fill="#333">${outerWidth}cm</text>
                        <text x="${startX - 25}" y="${startY + displayOuterHeight / 2}" text-anchor="middle" font-size="16" font-weight="600" fill="#333" transform="rotate(-90, ${startX - 25}, ${startY + displayOuterHeight / 2})">${outerHeight}cm</text>
                        <line x1="${startX + wallThickness}" y1="${startY + displayInnerHeight - 5}" x2="${startX + displayOuterWidth - wallThickness}" y2="${startY + displayInnerHeight - 5}" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"></line>
                        <text x="${startX + displayOuterWidth / 2}" y="${startY + displayInnerHeight - 10}" text-anchor="middle" font-size="14" font-weight="600" fill="#333">„Å∏„Åì„ÅøÂπÖ: ${indentWidth}cm</text>
                        <line x1="${startX + displayOuterWidth - wallThickness + 5}" y1="${startY + displayInnerHeight}" x2="${startX + displayOuterWidth - wallThickness + 5}" y2="${startY + displayOuterHeight}" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)" marker-start="url(#arrowhead)"></line>
                        <text x="${startX + displayOuterWidth - wallThickness + 25}" y="${startY + (displayInnerHeight + displayOuterHeight) / 2}" text-anchor="middle" font-size="14" font-weight="600" fill="#333" transform="rotate(-90, ${startX + displayOuterWidth - wallThickness + 25}, ${startY + (displayInnerHeight + displayOuterHeight) / 2})">„Å∏„Åì„ÅøÊ∑±„Åï: ${indentDepth}cm</text>
                    </g>
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
                        </marker>
                    </defs>
                </svg>
            `;

            setupSVGEventListeners(scale);
            makeDraggable('draggable-shape', scale);
            document.getElementById('u-shape-answer').style.display = 'block';
            currentResult = (outerWidth * outerHeight) - (indentWidth * innerHeight);
            currentShapeName = `„Ç≥„ÅÆÂ≠óÂûã (Â§ñ${outerWidth}√ó${outerHeight}, „Å∏„Åì„ÅøÂπÖ${indentWidth}, „Å∏„Åì„ÅøÊ∑±„Åï${indentDepth})`;
        }

        // Á©¥„ÅÇ„ÅçÂõõËßí„ÇíÊèèÁîª (Ëâ≤Â§âÊõ¥)
        function drawHollowSquare() {
            const outerSize = parseFloat(document.getElementById('hollow-outer-size').value);
            const innerSize = parseFloat(document.getElementById('hollow-inner-size').value);
            if (!outerSize || !innerSize) return;

            const maxSize = 300;
            const scale = maxSize / outerSize;
            const displayOuterSize = outerSize * scale;
            const displayInnerSize = innerSize * scale;
            const gridOuterX = Math.round((500 - displayOuterSize) / 2 / scale) * scale;
            const gridOuterY = Math.round((350 - displayOuterSize) / 2 / scale) * scale;
            const outerX = gridOuterX;
            const outerY = gridOuterY;
            const innerX = outerX + (displayOuterSize - displayInnerSize) / 2;
            const innerY = outerY + (displayOuterSize - displayInnerSize) / 2;

            const mainDisplay = document.getElementById('main-shape-display');
            mainDisplay.innerHTML = `
                <svg width="500" height="350" style="border: 2px solid #ddd; border-radius: 8px; background: white; user-select: none;">
                    ${drawGrid(null, 500, 350, scale)}
                    <g id="draggable-shape">
                        <rect x="${outerX}" y="${outerY}" width="${displayOuterSize}" height="${displayOuterSize}" fill="#FFEB3B" stroke="#FBC02D" stroke-width="3" opacity="0.8"></rect>
                        <rect x="${innerX}" y="${innerY}" width="${displayInnerSize}" height="${displayInnerSize}" fill="white" stroke="#FBC02D" stroke-width="3"></rect>
                        <text x="${outerX + displayOuterSize / 2}" y="${outerY - 10}" text-anchor="middle" font-size="16" font-weight="600" fill="#333">Â§ñÂÅ¥: ${outerSize}cm</text>
                        <text x="${innerX + displayInnerSize / 2}" y="${innerY + displayInnerSize / 2 + 5}" text-anchor="middle" font-size="16" font-weight="600" fill="#666">ÂÜÖÂÅ¥: ${innerSize}cm</text>
                    </g>
                </svg>
            `;

            setupSVGEventListeners(scale);
            makeDraggable('draggable-shape', scale);
            document.getElementById('hollow-square-answer').style.display = 'block';
            currentResult = (outerSize * outerSize) - (innerSize * innerSize);
            currentShapeName = `Á©¥„ÅÇ„ÅçÊ≠£ÊñπÂΩ¢ (Â§ñ${outerSize}√ó${outerSize}, ÂÜÖ${innerSize}√ó${innerSize})`;
        }

        // LÂ≠óÂûã„ÇíÊèèÁîª (Ëâ≤Â§âÊõ¥)
        function drawLShape() {
            const width1 = parseFloat(document.getElementById('l-width1').value);
            const height1 = parseFloat(document.getElementById('l-height1').value);
            const width2 = parseFloat(document.getElementById('l-width2').value);
            const height2 = parseFloat(document.getElementById('l-height2').value);
            if (!width1 || !height1 || !width2 || !height2) return;

            const maxWidth = 400;
            const maxHeight = 280;
            const totalWidth = Math.max(width1, width2);
            const totalHeight = height1 + height2;
            const scaleX = maxWidth / totalWidth;
            const scaleY = maxHeight / totalHeight;
            const scale = Math.min(scaleX, scaleY);
            const displayWidth1 = width1 * scale;
            const displayHeight1 = height1 * scale;
            const displayWidth2 = width2 * scale;
            const displayHeight2 = height2 * scale;
            const gridStartX = Math.round((500 - Math.max(displayWidth1, displayWidth2)) / 2 / scale) * scale;
            const gridStartY = Math.round((350 - (displayHeight1 + displayHeight2)) / 2 / scale) * scale;
            const startX = gridStartX;
            const startY = gridStartY;
            const path = `M ${startX} ${startY} L ${startX + displayWidth1} ${startY} L ${startX + displayWidth1} ${startY + displayHeight1} L ${startX + displayWidth2} ${startY + displayHeight1} L ${startX + displayWidth2} ${startY + displayHeight1 + displayHeight2} L ${startX} ${startY + displayHeight1 + displayHeight2} Z`;

            const mainDisplay = document.getElementById('main-shape-display');
            mainDisplay.innerHTML = `
                <svg width="500" height="350" style="border: 2px solid #ddd; border-radius: 8px; background: white; user-select: none;">
                    ${drawGrid(null, 500, 350, scale)}
                    <g id="draggable-shape">
                        <path d="${path}" fill="#FFEB3B" stroke="#FBC02D" stroke-width="3" opacity="0.8"></path>
                        <text x="${startX + displayWidth1 / 2}" y="${startY - 10}" text-anchor="middle" font-size="16" font-weight="600" fill="#333">${width1}cm</text>
                        <text x="${startX - 20}" y="${startY + displayHeight1 / 2}" text-anchor="middle" font-size="16" font-weight="600" fill="#333" transform="rotate(-90, ${startX - 20}, ${startY + displayHeight1 / 2})">${height1}cm</text>
                        <text x="${startX + displayWidth2 / 2}" y="${startY + displayHeight1 + displayHeight2 + 20}" text-anchor="middle" font-size="16" font-weight="600" fill="#333">${width2}cm</text>
                        <text x="${startX + displayWidth2 + 20}" y="${startY + displayHeight1 + displayHeight2 / 2}" text-anchor="middle" font-size="16" font-weight="600" fill="#333" transform="rotate(-90, ${startX + displayWidth2 + 20}, ${startY + displayHeight1 + displayHeight2 / 2})">${height2}cm</text>
                    </g>
                </svg>
            `;

            setupSVGEventListeners(scale);
            makeDraggable('draggable-shape', scale);
            document.getElementById('l-shape-answer').style.display = 'block';
            currentResult = (width1 * height1) + (width2 * height2);
            currentShapeName = `LÂ≠óÂûã (${width1}√ó${height1} + ${width2}√ó${height2})`;
        }


        // --- Á≠î„Åà„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞Áæ§ (Â§âÊõ¥„Å™„Åó) ---
        function checkRectangleAnswer() {
            const userAnswer = parseFloat(document.getElementById('rect-answer').value);
            const width = parseFloat(document.getElementById('rect-width').value);
            const height = parseFloat(document.getElementById('rect-height').value);
            const correctAnswer = width * height;
            const resultElement = document.getElementById('rectangle-result');
            if (Math.abs(userAnswer - correctAnswer) < 0.01) {
                resultElement.textContent = `üéâ Ê≠£Ëß£„Åß„ÅôÔºÅÈù¢Á©ç = ${width} √ó ${height} = ${correctAnswer} cm¬≤`;
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅØ ${correctAnswer} cm¬≤ „Åß„Åô„ÄÇË®àÁÆóÂºè: ${width} √ó ${height} = ${correctAnswer}`;
                resultElement.className = 'result incorrect';
            }
            resultElement.style.display = 'block';
        }
        function checkSquareAnswer() {
            const userAnswer = parseFloat(document.getElementById('square-answer-input').value);
            const side = parseFloat(document.getElementById('square-side').value);
            const correctAnswer = side * side;
            const resultElement = document.getElementById('square-result');
            if (Math.abs(userAnswer - correctAnswer) < 0.01) {
                resultElement.textContent = `üéâ Ê≠£Ëß£„Åß„ÅôÔºÅÈù¢Á©ç = ${side} √ó ${side} = ${correctAnswer} cm¬≤`;
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅØ ${correctAnswer} cm¬≤ „Åß„Åô„ÄÇË®àÁÆóÂºè: ${side} √ó ${side} = ${correctAnswer}`;
                resultElement.className = 'result incorrect';
            }
            resultElement.style.display = 'block';
        }
        function checkTriangleAnswer() {
            const userAnswer = parseFloat(document.getElementById('triangle-answer-input').value);
            const base = parseFloat(document.getElementById('triangle-base').value);
            const height = parseFloat(document.getElementById('triangle-height').value);
            const correctAnswer = (base * height) / 2;
            const resultElement = document.getElementById('triangle-result');
            if (Math.abs(userAnswer - correctAnswer) < 0.01) {
                resultElement.textContent = `üéâ Ê≠£Ëß£„Åß„ÅôÔºÅÈù¢Á©ç = ${base} √ó ${height} √∑ 2 = ${correctAnswer} cm¬≤`;
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅØ ${correctAnswer} cm¬≤ „Åß„Åô„ÄÇË®àÁÆóÂºè: ${base} √ó ${height} √∑ 2 = ${correctAnswer}`;
                resultElement.className = 'result incorrect';
            }
            resultElement.style.display = 'block';
        }
        function checkParallelogramAnswer() {
            const userAnswer = parseFloat(document.getElementById('parallelogram-answer-input').value);
            const base = parseFloat(document.getElementById('para-base').value);
            const height = parseFloat(document.getElementById('para-height').value);
            const correctAnswer = base * height;
            const resultElement = document.getElementById('parallelogram-result');
            if (Math.abs(userAnswer - correctAnswer) < 0.01) {
                resultElement.textContent = `üéâ Ê≠£Ëß£„Åß„ÅôÔºÅÈù¢Á©ç = ${base} √ó ${height} = ${correctAnswer} cm¬≤`;
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅØ ${correctAnswer} cm¬≤ „Åß„Åô„ÄÇË®àÁÆóÂºè: ${base} √ó ${height} = ${correctAnswer}`;
                resultElement.className = 'result incorrect';
            }
            resultElement.style.display = 'block';
        }
        function checkUShapeAnswer() {
            const userAnswer = parseFloat(document.getElementById('u-shape-answer-input').value);
            const outerWidth = parseFloat(document.getElementById('u-outer-width').value);
            const outerHeight = parseFloat(document.getElementById('u-outer-height').value);
            const indentWidth = parseFloat(document.getElementById('u-indent-width').value);
            const indentDepth = parseFloat(document.getElementById('u-indent-depth').value);
            const innerHeight = outerHeight - indentDepth;
            const correctAnswer = (outerWidth * outerHeight) - (indentWidth * innerHeight);
            const resultElement = document.getElementById('u-shape-result');
            if (Math.abs(userAnswer - correctAnswer) < 0.01) {
                resultElement.textContent = `üéâ Ê≠£Ëß£„Åß„ÅôÔºÅÈù¢Á©ç = (${outerWidth} √ó ${outerHeight}) - (${indentWidth} √ó (${outerHeight} - ${indentDepth})) = ${correctAnswer} cm¬≤`;
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅØ ${correctAnswer} cm¬≤ „Åß„Åô„ÄÇË®àÁÆóÂºè: (${outerWidth} √ó ${outerHeight}) - (${indentWidth} √ó (${outerHeight} - ${indentDepth})) = ${correctAnswer}`;
                resultElement.className = 'result incorrect';
            }
            resultElement.style.display = 'block';
        }
        function checkHollowSquareAnswer() {
            const userAnswer = parseFloat(document.getElementById('hollow-square-answer-input').value);
            const outerSize = parseFloat(document.getElementById('hollow-outer-size').value);
            const innerSize = parseFloat(document.getElementById('hollow-inner-size').value);
            const correctAnswer = (outerSize * outerSize) - (innerSize * innerSize);
            const resultElement = document.getElementById('hollow-square-result');
            if (Math.abs(userAnswer - correctAnswer) < 0.01) {
                resultElement.textContent = `üéâ Ê≠£Ëß£„Åß„ÅôÔºÅÈù¢Á©ç = (${outerSize} √ó ${outerSize}) - (${innerSize} √ó ${innerSize}) = ${correctAnswer} cm¬≤`;
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅØ ${correctAnswer} cm¬≤ „Åß„Åô„ÄÇË®àÁÆóÂºè: (${outerSize} √ó ${outerSize}) - (${innerSize} √ó ${innerSize}) = ${correctAnswer}`;
                resultElement.className = 'result incorrect';
            }
            resultElement.style.display = 'block';
        }
        function checkLShapeAnswer() {
            const userAnswer = parseFloat(document.getElementById('l-shape-answer-input').value);
            const width1 = parseFloat(document.getElementById('l-width1').value);
            const height1 = parseFloat(document.getElementById('l-height1').value);
            const width2 = parseFloat(document.getElementById('l-width2').value);
            const height2 = parseFloat(document.getElementById('l-height2').value);
            const correctAnswer = (width1 * height1) + (width2 * height2);
            const resultElement = document.getElementById('l-shape-result');
            if (Math.abs(userAnswer - correctAnswer) < 0.01) {
                resultElement.textContent = `üéâ Ê≠£Ëß£„Åß„ÅôÔºÅÈù¢Á©ç = (${width1} √ó ${height1}) + (${width2} √ó ${height2}) = ${correctAnswer} cm¬≤`;
                resultElement.className = 'result correct';
            } else {
                resultElement.textContent = `‚ùå ‰∏çÊ≠£Ëß£„Åß„Åô„ÄÇÊ≠£„Åó„ÅÑÁ≠î„Åà„ÅØ ${correctAnswer} cm¬≤ „Åß„Åô„ÄÇË®àÁÆóÂºè: (${width1} √ó ${height1}) + (${width2} √ó ${height2}) = ${correctAnswer}`;
                resultElement.className = 'result incorrect';
            }
            resultElement.style.display = 'block';
        }

        // ‚ñº‚ñº‚ñº ÁµêÊûú„ÇØ„É™„Ç¢Èñ¢Êï∞ (‰øÆÊ≠£) ‚ñº‚ñº‚ñº
        function clearResults() {
            document.querySelectorAll('.result').forEach(result => {
                result.style.display = 'none';
            });
            document.querySelectorAll('.shape-display').forEach(display => {
                display.style.display = 'none';
            });
            document.querySelectorAll('.answer-section').forEach(section => {
                section.style.display = 'none';
            });
            currentResult = null;
            currentShapeName = '';

            svgElement = null;
            svgRect = null;
            isDrawingLine = false;
            previewLine = null;
            dragInitialTransform = { x: 0, y: 0 }; // ‚òÖ ÁßªÂãïÈáè„ÇÇ„É™„Çª„ÉÉ„Éà
        }

        // ‚ñº‚ñº‚ñº „Éâ„É©„ÉÉ„Ç∞Ê©üËÉΩ (Â§âÊõ¥„Å™„Åó) ‚ñº‚ñº‚ñº
        // „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÁßªÂãï„Åó„ÄÅ‰ªñ„ÅÆÈñ¢Êï∞„Åã„Çâ„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Å´„Åô„Çã
        let isDragging = false;
        let dragStartX, dragStartY;

        function makeDraggable(elementId, gridScale) {
            const element = document.getElementById(elementId);
            if (!element) return;
            updateCursors(); // ÂàùÊúü„Ç´„Éº„ÇΩ„É´Ë®≠ÂÆö
        }

        // ‚ñº‚ñº‚ñº „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ© (‰øÆÊ≠£) ‚ñº‚ñº‚ñº
        function getCurrentTransform(element) {
            if (!element) return { x: 0, y: 0 };
            const transform = element.getAttribute('transform') || '';
            const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
            if (match) {
                // transform Â±ûÊÄß„ÅåÂ≠òÂú®„Åô„Çå„Å∞„Åù„ÅÆÂÄ§„ÇíËøî„Åô
                return { x: parseFloat(match[1]), y: parseFloat(match[2]) };
            }
            // transform Â±ûÊÄß„Åå„Å™„Åë„Çå„Å∞ (0, 0) „ÇíËøî„Åô
            return { x: 0, y: 0 };
        }

        // ‚ñº‚ñº‚ñº „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ© (‰øÆÊ≠£) ‚ñº‚ñº‚ñº
        function applyTransform(element, x, y, gridScale) {
            if (!element) return;
            const snappedX = Math.round(x / gridScale) * gridScale;
            const snappedY = Math.round(y / gridScale) * gridScale;
            element.setAttribute('transform', `translate(${snappedX}, ${snappedY})`);
            // ‚òÖ „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å∏„ÅÆ‰øùÂ≠ò„ÅØÂâäÈô§ (dragInitialTransform „ÅØÈñãÂßãÊôÇ„ÅÆ„Åø)
        }

        // ‚ñº‚ñº‚ñº „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ© (‰øÆÊ≠£) ‚ñº‚ñº‚ñº
        function onDragStart(e) {
            const element = document.getElementById('draggable-shape');
            // ÁßªÂãï„É¢„Éº„Éâ„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØÂõ≥ÂΩ¢‰∏ä‰ª•Â§ñ„ÅßÈñãÂßã„Åó„ÅüÂ†¥Âêà„ÅØ„Éâ„É©„ÉÉ„Ç∞„Åó„Å™„ÅÑ
            if (currentMode !== 'move' || !e.target.closest('#draggable-shape') || !element) {
                isDragging = false;
                return;
            }

            isDrawingLine = false;
            isDragging = true;
            const touch = e.touches ? e.touches[0] : e;
            dragStartX = touch.clientX;
            dragStartY = touch.clientY;
            dragInitialTransform = getCurrentTransform(element); // ‚òÖ ÈñãÂßãÊôÇ„ÅÆÁßªÂãïÈáè„ÇíÂèñÂæó„Éª‰øùÂ≠ò
            element.style.cursor = 'grabbing'; // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„ÅøÊé¥„ÇÄ„Ç´„Éº„ÇΩ„É´
            e.preventDefault();
        }

        // ‚ñº‚ñº‚ñº „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ© (‰øÆÊ≠£) ‚ñº‚ñº‚ñº
        function onDragMove(e) {
            if (!isDragging) return;
            const element = document.getElementById('draggable-shape');
            if (!element) return;

            e.preventDefault();
            const touch = e.touches ? e.touches[0] : e;
            const deltaX = touch.clientX - dragStartX;
            const deltaY = touch.clientY - dragStartY;
            // ‚òÖ ÈñãÂßãÊôÇ„ÅÆ Transform ÂÄ§„ÇíÂü∫Ê∫ñ„Å´Ë®àÁÆó
            const newX = dragInitialTransform.x + deltaX;
            const newY = dragInitialTransform.y + deltaY;
            applyTransform(element, newX, newY, currentGridScale);
        }

        // ‚ñº‚ñº‚ñº „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ© (‰øÆÊ≠£„Å™„Åó) ‚ñº‚ñº‚ñº
        function onDragEnd() {
            if (isDragging) {
                isDragging = false;
                updateCursors(); // „Ç´„Éº„ÇΩ„É´„Çí„É¢„Éº„Éâ„Å´Âêà„Çè„Åõ„Å¶Êàª„Åô
            }
        }


        // --- Êñ∞Ê©üËÉΩ„ÅÆÈñ¢Êï∞ ---

        // Êìç‰Ωú„É¢„Éº„ÉâÂ§âÊõ¥ÊôÇ„ÅÆ„Ç´„Éº„ÇΩ„É´Êõ¥Êñ∞
        function updateCursors() {
            const shape = document.getElementById('draggable-shape');

            if (currentMode === 'move') {
                if (svgElement) svgElement.style.cursor = 'auto';
                if (shape) shape.style.cursor = 'move';
            } else { // 'draw'
                if (svgElement) svgElement.style.cursor = 'crosshair';
                if (shape) shape.style.cursor = 'crosshair';
            }
        }

        // ÊñπÁúº„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
        function toggleGrid() {
            const gridLayer = document.getElementById('grid-layer');
            const gridToggle = document.getElementById('grid-toggle');
            if (gridLayer && gridToggle) {
                gridLayer.style.display = gridToggle.checked ? 'block' : 'none';
            }
        }

        // „É¶„Éº„Ç∂„Éº„ÅåÊèèÁîª„Åó„ÅüÁ∑ö„Çí„Åô„Åπ„Å¶ÂâäÈô§ (‰øÆÊ≠£)
        function clearUserLines() {
             const shapeGroup = document.getElementById('draggable-shape');
             if (shapeGroup) {
                 const lines = shapeGroup.querySelectorAll('line'); // ‚òÖ „Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆ line „ÇíÈÅ∏Êäû
                 lines.forEach(line => line.remove());
             }
        }

        // ‚ñº‚ñº‚ñº „Éû„Ç¶„ÇπÂ∫ßÊ®ô„ÇíSVGÂ∫ßÊ®ô„Å´Â§âÊèõ„Åó„ÄÅ„Ç∞„É™„ÉÉ„Éâ„Å´„Çπ„Éä„ÉÉ„Éó„Åô„Çã (‰øÆÊ≠£) ‚ñº‚ñº‚ñº
        function getSVGPoint(e) {
            if (!svgElement) return { x: 0, y: 0 };

            if (!svgRect || e.type === 'mousedown' || e.type === 'touchstart') {
                 svgRect = svgElement.getBoundingClientRect();
            }

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // SVG„Ç≠„É£„É≥„Éê„Çπ‰∏ä„ÅÆÂ∫ßÊ®ô
            const svgX = clientX - svgRect.left;
            const svgY = clientY - svgRect.top;

            // ‚òÖ „Ç∞„É´„Éº„Éó„ÅÆÁèæÂú®„ÅÆÁßªÂãïÈáè„ÇíÂèñÂæó„Åó„Å¶ËÄÉÊÖÆ
            const shapeGroup = document.getElementById('draggable-shape');
            const currentTransform = getCurrentTransform(shapeGroup); // ‚òÖ Â∏∏„Å´ÊúÄÊñ∞„ÅÆ transform „ÇíÂèñÂæó

            const groupRelativeX = svgX - currentTransform.x;
            const groupRelativeY = svgY - currentTransform.y;

            // „Ç∞„É™„ÉÉ„Éâ„Å´„Çπ„Éä„ÉÉ„Éó
            const snappedX = Math.round(groupRelativeX / currentGridScale) * currentGridScale;
            const snappedY = Math.round(groupRelativeY / currentGridScale) * currentGridScale;

            return { x: snappedX, y: snappedY };
        }

        // Á∑öÊèèÁîªÈñãÂßã (Â§âÊõ¥„Å™„Åó)
        function startDrawLine(e) {
            if (currentMode !== 'draw' || isDragging) {
                isDrawingLine = false;
                return;
            }

            e.preventDefault();
            isDrawingLine = true;
            startLinePoint = getSVGPoint(e);

            const lineStyle = '5,5'; // Â∏∏„Å´ÁÇπÁ∑ö

            previewLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            previewLine.setAttribute('x1', startLinePoint.x);
            previewLine.setAttribute('y1', startLinePoint.y);
            previewLine.setAttribute('x2', startLinePoint.x);
            previewLine.setAttribute('y2', startLinePoint.y);
            previewLine.setAttribute('stroke', '#000');
            previewLine.setAttribute('stroke-width', '3');
            previewLine.setAttribute('stroke-dasharray', lineStyle);
            previewLine.style.pointerEvents = 'none';

            const shapeGroup = document.getElementById('draggable-shape');
            if (shapeGroup) {
                shapeGroup.appendChild(previewLine);
            }
        }

        // Á∑öÊèèÁîª‰∏≠ (Â§âÊõ¥„Å™„Åó)
        function drawLineMove(e) {
            if (!isDrawingLine || !previewLine) return;

            e.preventDefault();
            const currentPoint = getSVGPoint(e);
            previewLine.setAttribute('x2', currentPoint.x);
            previewLine.setAttribute('y2', currentPoint.y);
        }

        // Á∑öÊèèÁîªÁµÇ‰∫Ü (Â§âÊõ¥„Å™„Åó)
        function endDrawLine(e) {
            if (!isDrawingLine) return;
            isDrawingLine = false;

            if (previewLine) {
                 const x1 = previewLine.getAttribute('x1');
                 const y1 = previewLine.getAttribute('y1');
                 const x2 = previewLine.getAttribute('x2');
                 const y2 = previewLine.getAttribute('y2');

                 if (x1 === x2 && y1 === y2) {
                     previewLine.remove();
                 } else {
                     previewLine.setAttribute('stroke', '#000');
                     previewLine.setAttribute('stroke-width', '3');
                 }
            }
            previewLine = null;
        }

        // ÂàùÊúüÂåñÂá¶ÁêÜ (Â§âÊõ¥„Å™„Åó)
        document.getElementById('grid-toggle').addEventListener('change', toggleGrid);
        document.getElementById('clear-lines-btn').addEventListener('click', clearUserLines);

        // Êìç‰Ωú„É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„É™„Çπ„Éä„Éº
        document.querySelectorAll('input[name="op-mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentMode = e.target.value;
                isDrawingLine = false;
                if (previewLine) previewLine.remove();
                previewLine = null;
                isDragging = false;

                updateCursors(); // „É¢„Éº„ÉâÂ§âÊõ¥ÊôÇ„Å´„Ç´„Éº„ÇΩ„É´„ÇíÊõ¥Êñ∞
            });
        });

        window.addEventListener('resize', () => {
            if (svgElement) {
                svgRect = svgElement.getBoundingClientRect();
            }
        });

    </script>
</body>
</html>
